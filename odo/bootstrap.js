// Generated by IcedCoffeeScript 1.6.3-f
(function() {
  var iced, __iced_k, __iced_k_noop;

  iced = require('iced-coffee-script').iced;
  __iced_k = __iced_k_noop = function() {};

  define(['module', 'express', 'path', 'fs', 'peekinto', 'odo/plugins', 'odo/config'], function(module, express, path, fs, peek, plugins, config) {
    return function(cb) {
      var app, key, value, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      app = express();
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "/Users/tcoats/Source/thomascoats.com/odo/bootstrap.coffee"
        });
        plugins.loadplugins(config.plugins.directories, __iced_deferrals.defer({
          lineno: 5
        }));
        __iced_deferrals._fulfill();
      })(function() {
        var _ref;
        _ref = config.express;
        for (key in _ref) {
          value = _ref[key];
          app.set(key, value);
        }
        app.configure(function() {
          var route, ___iced_passed_deferral1, __iced_deferrals, __iced_k, _i, _len, _ref1;
          __iced_k = __iced_k_noop;
          ___iced_passed_deferral1 = iced.findDeferral(arguments);
          app.use(express.compress());
          app.use(express.bodyParser());
          app.use(express.methodOverride());
          app.use(express.cookieParser(app.get('cookie secret')));
          app.use(express.cookieSession({
            key: app.get('session key'),
            secret: app.get('session secret')
          }));
          _ref1 = config.routes;
          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
            route = _ref1[_i];
            app.use(route.source, express["static"](path.join(path.dirname(module.uri), '../', route.target)));
          }
          peek(app);
          (function(__iced_k) {
            __iced_deferrals = new iced.Deferrals(__iced_k, {
              parent: ___iced_passed_deferral1,
              filename: "/Users/tcoats/Source/thomascoats.com/odo/bootstrap.coffee"
            });
            plugins.configure(app, __iced_deferrals.defer({
              lineno: 31
            }));
            __iced_deferrals._fulfill();
          })(function() {
            app.use(app.router);
            return app.use(express.errorHandler({
              dumpExceptions: true,
              showStack: true
            }));
          });
        });
        app.listen(process.env.PORT || 80);
        (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            parent: ___iced_passed_deferral,
            filename: "/Users/tcoats/Source/thomascoats.com/odo/bootstrap.coffee"
          });
          plugins.init(app, __iced_deferrals.defer({
            lineno: 43
          }));
          __iced_deferrals._fulfill();
        })(function() {
          return cb(app);
        });
      });
    };
  });

}).call(this);
